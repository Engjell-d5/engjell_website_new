// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:../data/database.db"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      String   // 'admin' | 'editor'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  blogs Blog[]
  pushSubscriptions PushSubscription[]

  @@map("users")
}

model PushSubscription {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint    String   @unique
  p256dh      String   // Public key for encryption
  auth        String   // Auth secret for encryption
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("push_subscriptions")
}

model Blog {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  category    String
  excerpt     String
  hook         String?  // Hook sentence to grab attention
  content     String   @default("")
  imageUrl    String
  published   Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // SEO fields stored as JSON
  seoMetaTitle        String?
  seoMetaDescription  String?
  seoKeywords         String?
  seoOgTitle          String?
  seoOgDescription    String?
  seoOgImage          String?
  seoTwitterCard      String?
  seoTwitterTitle     String?
  seoTwitterDescription String?
  seoTwitterImage     String?

  campaigns Campaign[]

  @@map("blogs")
}

model YouTubeVideo {
  id          String   @id @default(cuid())
  videoId     String   @unique
  title       String
  description String   @default("")
  thumbnailUrl String
  publishedAt DateTime
  duration    String
  viewCount   String
  channelTitle String
  fetchedAt   DateTime @default(now())
  featured    Boolean  @default(false)
  removed     Boolean  @default(false)

  @@map("youtube_videos")
}

model Config {
  id                    String   @id @default(cuid())
  youtubeApiKey         String   @default("")
  youtubeChannelId      String   @default("")
  cronSchedule          String   @default("0 2 * * *")
  socialMediaCronSchedule String @default("*/5 * * * *")
  lastVideoFetch        DateTime?

  @@map("config")
}

model Subscriber {
  id              String   @id @default(cuid())
  email           String   @unique
  subscribedAt    DateTime @default(now())
  syncedToSender  Boolean  @default(false)
  status          String   @default("active") // 'active' | 'churned'
  groupId         String?  // Legacy: single group for backward compatibility
  group           Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)
  groups          SubscriberGroup[]

  @@map("subscribers")
}

model SubscriberGroup {
  id          String     @id @default(cuid())
  subscriberId String
  groupId     String
  subscriber  Subscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  group       Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdAt   DateTime   @default(now())

  @@unique([subscriberId, groupId])
  @@map("subscriber_groups")
}

model Group {
  id                    String   @id @default(cuid())
  senderGroupId         String?  @unique // Sender.net group ID
  title                 String
  recipientCount        Int      @default(0)
  activeSubscribers     Int      @default(0)
  unsubscribedCount     Int      @default(0)
  bouncedCount          Int      @default(0)
  phoneCount            Int      @default(0)
  activePhoneCount      Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  syncedAt              DateTime?
  
  subscribers           Subscriber[] // Legacy: single group relation
  subscriberGroups      SubscriberGroup[] // Many-to-many relation
  campaigns             Campaign[]
  
  @@map("groups")
}

model PodcastApplication {
  id               String   @id @default(cuid())
  name             String
  email            String
  about            String
  businesses       String
  industry         String
  vision           String
  biggestChallenge String
  whyPodcast       String
  submittedAt      DateTime @default(now())
  status           String   @default("pending") // 'pending' | 'reviewed' | 'approved' | 'rejected'

  @@map("podcast_applications")
}

model ContactMessage {
  id          String   @id @default(cuid())
  name        String
  email       String
  message     String
  submittedAt DateTime @default(now())
  read        Boolean  @default(false)

  @@map("contact_messages")
}

model SocialConnection {
  id            String   @id @default(cuid())
  platform      String   // 'linkedin' | 'twitter' | 'instagram' | 'threads'
  accessToken   String   // Encrypted token
  refreshToken  String?  // For token refresh
  expiresAt     DateTime? // Token expiration
  connectedAt   DateTime @default(now())
  isActive      Boolean  @default(true)
  username      String?  // Platform username for display
  profileImage  String?  // Profile image URL
  organizations String?  // JSON array: [{'id': '...', 'name': '...', 'urn': '...'}] - LinkedIn organizations for mentions
  
  @@unique([platform])
  @@map("social_connections")
}

model SocialPost {
  id              String   @id @default(cuid())
  content         String
  mediaAssets     String?  // JSON array: [{'type': 'image'|'video', 'url': '...', 'filename': '...'}]
  platforms       String   // JSON array: ['linkedin', 'twitter', ...]
  scheduledFor    DateTime
  publishedAt     DateTime?
  status          String   @default("scheduled") // 'scheduled' | 'published' | 'failed' | 'draft'
  publishedOn     String?  // JSON: {'linkedin': '2024-01-01', 'twitter': '2024-01-01'}
  errorMessage    String?
  timesPosted     Int      @default(0) // Number of times this post has been published
  comments        String?  // JSON array: ['comment1', 'comment2', ...] - Optional comments to post after the main post
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // User ID who created the post
  
  @@map("social_posts")
}

model Campaign {
  id                    String   @id @default(cuid())
  senderCampaignId      String?  @unique // Sender.net campaign ID
  blogId                String?  // Optional: link to blog post
  blog                  Blog?    @relation(fields: [blogId], references: [id], onDelete: SetNull)
  
  // Campaign details
  title                 String?
  subject               String
  from                  String
  preheader             String?
  replyTo               String
  contentType           String   @default("html") // 'editor' | 'html' | 'text'
  content               String   // HTML or text content
  
  // Campaign settings
  googleAnalytics       Boolean  @default(false)
  autoFollowupActive    Boolean  @default(false)
  autoFollowupSubject   String?
  autoFollowupDelay     Int?     // Hours: 12, 24, 48, 72, 96, 120, 144, or 168
  
  // Recipients
  groups                String?  // JSON array of group IDs
  segments              String?  // JSON array of segment IDs
  groupId               String?  // Primary group for this campaign
  group                 Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)
  
  // Status and tracking
  status                String   @default("DRAFT") // 'DRAFT' | 'SCHEDULED' | 'SENDING' | 'SENT'
  scheduleTime          DateTime?
  sentTime              DateTime?
  recipientCount        Int      @default(0)
  sentCount             Int      @default(0)
  opens                 Int      @default(0)
  clicks                Int      @default(0)
  bouncesCount          Int      @default(0)
  
  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  syncedAt              DateTime? // Last sync with Sender.net
  
  @@map("campaigns")
}

model AiIntegration {
  id            String   @id @default(cuid())
  name          String   // Display name (e.g., "My ChatGPT", "Gemini Pro")
  provider      String   // 'openai' | 'google' | 'anthropic' | etc.
  apiKey        String   // Encrypted API key
  model         String?  // Model name (e.g., "gpt-4", "gemini-pro")
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("ai_integrations")
}

model PostIdea {
  id            String   @id @default(cuid())
  title         String   // Idea title/description
  prompt        String   // The prompt that generated this idea
  content       String?  // Optional: generated content for the idea
  platforms     String?  // JSON array: ['linkedin', 'twitter', ...]
  status        String   @default("draft") // 'draft' | 'generated' | 'archived'
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?  // User ID who created the idea
  
  @@map("post_ideas")
}

model GoogleConnection {
  id            String   @id @default(cuid())
  accessToken   String   // Encrypted token
  refreshToken  String?  // For token refresh
  expiresAt     DateTime? // Token expiration
  connectedAt   DateTime @default(now())
  isActive      Boolean  @default(true)
  email         String?  // Google account email for display
  
  @@map("google_connections")
}

model Email {
  id            String   @id @default(cuid())
  gmailId       String   @unique // Gmail message ID
  threadId      String   // Gmail thread ID for grouping
  subject       String
  from          String   // Sender email
  to            String?  // Recipient email
  snippet       String?  // Email preview snippet
  body          String?  // Full email body (HTML or text)
  bodyText      String?  // Plain text version
  receivedAt    DateTime // When email was received
  isRead        Boolean  @default(false) // Read status from Gmail
  isAnalyzed    Boolean  @default(false) // Whether this email has been analyzed for tasks
  isIrrelevant  Boolean  @default(false) // Whether this email is marked as irrelevant
  syncedAt      DateTime @default(now())
  lastSyncedAt  DateTime? // Last time this email was synced
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  tasks         EmailTask[] // Tasks generated from this email
  
  @@map("emails")
}

model EmailTask {
  id            String   @id @default(cuid())
  emailId       String
  email         Email    @relation(fields: [emailId], references: [id], onDelete: Cascade)
  title         String   // Task title
  description   String?  // Task description
  priority      String   @default("medium") // 'low' | 'medium' | 'high'
  status        String   @default("pending") // 'pending' | 'in_progress' | 'completed' | 'cancelled'
  aiAnalysis    String?  // JSON: AI analysis details
  externalTaskId String? // ID of task created on external platform (app.division5.co)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("email_tasks")
}

model EmailCronJob {
  id            String   @id @default(cuid())
  isEnabled     Boolean  @default(false) // Whether the cron job is enabled
  schedule      String   @default("0 */6 * * *") // Cron schedule (default: every 6 hours)
  syncEmails    Boolean  @default(true) // Whether to sync emails from Gmail
  analyzeEmails Boolean  @default(true) // Whether to analyze emails after syncing
  aiIntegrationId String? // AI Integration ID to use for analysis
  lastRun       DateTime? // Last time the cron job ran
  lastSyncAt    DateTime? // Last time emails were synced
  lastAnalyzeAt DateTime? // Last time emails were analyzed
  nextRun       DateTime? // Next scheduled run time
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("email_cron_jobs")
}
